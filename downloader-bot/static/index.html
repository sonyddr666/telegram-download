<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .progress-bar { transition: width 0.3s ease; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

  <header class="border-b border-gray-800 bg-gray-900">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center gap-3">
      <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
      </svg>
      <h1 class="text-xl font-bold">Video Downloader</h1>
      <span class="ml-auto text-xs bg-blue-900 text-blue-300 px-2 py-0.5 rounded-full">+1000 sites</span>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8 space-y-8">

    <!-- FormulÃ¡rio -->
    <section class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl">
      <h2 class="text-lg font-semibold mb-4">Novo download</h2>
      <div class="space-y-4">
        <div>
          <label class="text-sm text-gray-400 block mb-1">URL do vÃ­deo</label>
          <input id="urlInput" type="url"
            placeholder="https://www.youtube.com/watch?v=..."
            class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm
                   focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" />
        </div>

        <div>
          <label class="text-sm text-gray-400 block mb-2">Qualidade</label>
          <div class="grid grid-cols-5 gap-2" id="qualityBtns">
            <button onclick="selectQuality('best')"  data-q="best"
              class="quality-btn bg-blue-600 text-white text-sm py-2 rounded-lg font-medium transition-all">Melhor</button>
            <button onclick="selectQuality('1080p')" data-q="1080p"
              class="quality-btn bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded-lg font-medium transition-all">1080p</button>
            <button onclick="selectQuality('720p')"  data-q="720p"
              class="quality-btn bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded-lg font-medium transition-all">720p</button>
            <button onclick="selectQuality('480p')"  data-q="480p"
              class="quality-btn bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded-lg font-medium transition-all">480p</button>
            <button onclick="selectQuality('audio')" data-q="audio"
              class="quality-btn bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded-lg font-medium transition-all">ðŸŽµ MP3</button>
          </div>
        </div>

        <button id="downloadBtn" onclick="startDownload()"
          class="w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white
                 font-semibold py-3 rounded-xl transition-all flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Baixar
        </button>
      </div>
    </section>

    <!-- Lista de jobs -->
    <section>
      <h2 class="text-lg font-semibold mb-3">Downloads</h2>
      <div id="jobsList" class="space-y-3"></div>
      <p id="emptyMsg" class="text-gray-500 text-sm text-center py-10">Nenhum download ainda</p>
    </section>
  </main>

  <script>
    let selectedQuality = 'best';

    function selectQuality(q) {
      selectedQuality = q;
      document.querySelectorAll('.quality-btn').forEach(btn => {
        const active = btn.dataset.q === q;
        btn.className = `quality-btn text-sm py-2 rounded-lg font-medium transition-all ${
          active ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-200'
        }`;
      });
    }

    async function startDownload() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) return alert('Informe uma URL');

      const btn = document.getElementById('downloadBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Processando...';

      try {
        const res = await fetch('/api/jobs/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, quality: selectedQuality }),
        });
        if (!res.ok) throw new Error(await res.text());
        const { id } = await res.json();
        document.getElementById('urlInput').value = '';
        insertJob({ id, url, quality: selectedQuality, status: 'queued',
                    progress: { percent: '0%', speed: 'â€”', eta: 'â€”' }, title: '', thumbnail: '' });
        streamJob(id);
      } catch (e) {
        alert('Erro ao criar job:\n' + e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Baixar`;
      }
    }

    function insertJob(job) {
      document.getElementById('emptyMsg').style.display = 'none';
      if (document.getElementById(`job-${job.id}`)) return;
      const el = document.createElement('div');
      el.id = `job-${job.id}`;
      el.className = 'bg-gray-900 border border-gray-800 rounded-2xl p-4 fade-in';
      el.innerHTML = jobHTML(job);
      document.getElementById('jobsList').prepend(el);
    }

    function updateJob(id, patch) {
      const el = document.getElementById(`job-${id}`);
      if (!el) return;
      el.innerHTML = jobHTML({ id, ...patch });
    }

    function jobHTML(job) {
      const colors = {
        queued:  'bg-yellow-900 text-yellow-300',
        running: 'bg-blue-900   text-blue-300',
        done:    'bg-green-900  text-green-300',
        error:   'bg-red-900    text-red-300',
      };
      const labels = { queued: 'Na fila', running: 'Baixando', done: 'ConcluÃ­do', error: 'Erro' };
      const pct = parseInt((job.progress?.percent || '0').replace('%','')) || 0;

      let footer = '';
      if (job.status === 'running' || job.status === 'queued') {
        footer = `
          <div class="mt-3">
            <div class="flex justify-between text-xs text-gray-400 mb-1">
              <span>${job.progress?.percent || '0%'}</span>
              <span>${job.progress?.speed || 'â€”'} &nbsp;Â·&nbsp; ETA ${job.progress?.eta || 'â€”'}</span>
            </div>
            <div class="bg-gray-700 rounded-full h-1.5">
              <div class="bg-blue-500 h-1.5 rounded-full progress-bar" style="width:${pct}%"></div>
            </div>
          </div>`;
      } else if (job.status === 'done') {
        const isAudio = (job.filename || '').endsWith('.mp3');
        footer = `
          <div class="mt-3 space-y-2">
            ${isAudio
              ? `<audio controls class="w-full mt-1" src="/api/jobs/${job.id}/download-file"></audio>`
              : `<video controls class="w-full rounded-xl max-h-56 bg-black mt-1"
                   src="/api/jobs/${job.id}/download-file"></video>`}
            <a href="/api/jobs/${job.id}/download-file" download="${job.filename || 'video'}"
               class="flex items-center justify-center gap-2 bg-green-700 hover:bg-green-600
                      text-white text-sm font-medium py-2.5 rounded-xl transition-all">
              â¬‡ Download â€” ${job.filename || ''}
            </a>
          </div>`;
      } else if (job.status === 'error') {
        footer = `<p class="mt-2 text-sm text-red-400 bg-red-950/60 p-3 rounded-xl break-all">${job.error}</p>`;
      }

      const thumb = job.thumbnail
        ? `<img src="${job.thumbnail}" class="w-20 h-12 object-cover rounded-lg flex-shrink-0">`
        : `<div class="w-20 h-12 bg-gray-800 rounded-lg flex-shrink-0 flex items-center justify-center text-gray-600">
             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                 d="M15 10l4.553-2.069A1 1 0 0121 8.82v6.36a1 1 0 01-1.447.894L15 14
                    M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
             </svg></div>`;

      return `
        <div class="flex items-start gap-3">
          ${thumb}
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xs font-medium px-2 py-0.5 rounded-full ${colors[job.status] || ''}">
                ${labels[job.status] || job.status}
              </span>
              <span class="text-xs text-gray-500 font-mono">${job.quality || 'best'}</span>
              <span class="text-xs font-mono text-gray-600 ml-auto">#${job.id}</span>
            </div>
            <p class="text-sm font-medium text-gray-200 truncate">${job.title || job.url}</p>
            ${job.title ? `<p class="text-xs text-gray-500 truncate mt-0.5">${job.url}</p>` : ''}
          </div>
        </div>
        ${footer}`;
    }

    function streamJob(id) {
      const es = new EventSource(`/api/jobs/${id}/stream`);
      es.onmessage = (e) => {
        const data = JSON.parse(e.data);
        updateJob(id, { ...data, id });
        if (data.status === 'done' || data.status === 'error') es.close();
      };
      es.onerror = () => es.close();
    }

    async function loadJobs() {
      try {
        const jobs = await fetch('/api/jobs').then(r => r.json());
        if (jobs.length) {
          document.getElementById('emptyMsg').style.display = 'none';
          jobs.forEach(j => {
            insertJob(j);
            if (j.status === 'running' || j.status === 'queued') streamJob(j.id);
          });
        }
      } catch {}
    }

    loadJobs();
  </script>
</body>
</html>
